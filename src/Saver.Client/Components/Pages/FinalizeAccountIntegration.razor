@page "/finalizeintegration"

@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using Saver.AccountIntegrationService.Contracts
@using Saver.Client.Infrastructure
@using Saver.FinanceService.Contracts.BankAccounts

@inject ProtectedSessionStorage SessionStorage
@inject NavigationManager NavigationManager
@inject IBankAccountsApiClient BankAccountsApiClient
@inject IAccountIntegrationsApiClient AccountIntegrationsApiClient

@code {
    [Parameter, SupplyParameterFromQuery] public string Code { get; set; } = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        if (await SessionStorage.GetAsync<NewExternalBankAccountViewModel>(SessionDataKeys.ExternalBankAccountFormData) is { Success: true, Value: not null } value)
        {
            await BankAccountsApiClient.CreateExternalBankAccountAsync(new CreateExternalBankAccountRequest
            {
                Name = value.Value.Name,
                ProviderId = value.Value.ProviderId,
                CurrencyCode = "EUR"
            });

            await AccountIntegrationsApiClient.CreateAccountIntegrationAsync(new CreateAccountIntegrationRequest
            {
                AccountId = Guid.NewGuid(),
                ProviderId = value.Value.ProviderId,
                AuthorizationCode = Code
            });
        }


        NavigationManager.NavigateTo("/accounts");
    }

}
